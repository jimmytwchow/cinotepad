(()=>{"use strict";const e={start(){this.decoder=new TextDecoder(this.encoding,this.options)},transform(e,t){t.enqueue(this.decoder.decode(e,{stream:!0}))}},t=new WeakMap;class n extends TransformStream{constructor(n="utf-8",{...a}={}){let s={...e,encoding:n,options:a};super(s),t.set(this,s)}get encoding(){return t.get(this).decoder.encoding}get fatal(){return t.get(this).decoder.fatal}get ignoreBOM(){return t.get(this).decoder.ignoreBOM}}const a={transform(e,t){let n,a=0;for(;;){if(n=e.indexOf("\n",a),!(n>-1)){let n=e.substring(a);n=n.replaceAll("\r",""),0==n.length?this._remainChunk&&(n=this._remainChunk+n,t.enqueue(n),this._remainChunk=void 0):(this._remainChunk||(this._remainChunk=""),this._remainChunk+=n);break}{let s=e.substring(a,n);s=s.replaceAll("\r",""),this._remainChunk&&(s=this._remainChunk+s,this._remainChunk=void 0),t.enqueue(s),a=n+1}}},flush(e){this._remainChunk&&(e.enqueue(this._remainChunk),this._remainChunk=void 0)}};class s extends TransformStream{constructor({...e}={}){super({...a,options:e})}}function i(e){let t,n,a;return t=e.indexOf(" "),n=e.indexOf("\t"),a=-1==n||t>-1&&t<n?t:n,a}async function r(e,t){let{done:n,value:a}=await e.read();if(n)return t;if(a.length>0){if(a.startsWith("%keyname end"))return t;if(a.startsWith(" # ")&&a.length>3)t.keyname["#"]=a.substring(3);else{let e=i(a);e>0&&e<a.length-1&&(t.keyname[a.substring(0,e)]=a.substring(e+1).trim())}}return await r(e,t)}async function o(e,t){let{done:n,value:a}=await e.read();if(n)return t;{let n,s;if(a.length>0){if(a.startsWith("%quick end"))return t;if(a.startsWith(" # ")&&a.length>3)n="#",s=a.substring(3).trim(),t.unwrittenQuickList.push({keycode:n,candidates:s});else{let e=i(a);e>0&&e<a.length-1&&(n=a.substring(0,e),s=a.substring(e+1).trim(),t.unwrittenQuickList.push({keycode:n,candidates:s}),t.maxNumOfKeys=Math.max(t.maxNumOfKeys,n.length))}}return await o(e,t)}}async function c(e,t){let{done:n,value:a}=await e.read();if(n)return t;{let n,s;if(a.length>0){if(a.startsWith("%chardef end"))return t;if(a.startsWith(" # ")&&a.length>3)n="#",s=a.substring(3).trim(),t.unwrittenCharDefList.push({keycode:n,candidate:s});else{let e=i(a);e>0&&e<a.length-1&&(n=a.substring(0,e),s=a.substring(e+1).trim(),t.unwrittenCharDefList.push({keycode:n,candidate:s}),t.maxNumOfKeys=Math.max(t.maxNumOfKeys,n.length))}}return await c(e,t)}}async function l(e,t){let{done:n,value:a}=await e.read();if(n){if(t.dupsel||(t.dupsel=t.selkey.length),!t.keepKeyCase){const e=t.keyname;t.keyname={};for(let n in e)t.keyname[n.toLowerCase()]=e[n];for(let e in t.unwrittenQuickList)t.unwrittenQuickList[e].keycode=t.unwrittenQuickList[e].keycode.toLowerCase();for(let e in t.unwrittenCharDefList)t.unwrittenCharDefList[e].keycode=t.unwrittenCharDefList[e].keycode.toLowerCase()}return t}return a=function(e){let t=e.indexOf("#");return t>-1&&(e=e.substring(0,t).trim()),e}(a),a.length>0&&(a.startsWith("%gen_inp")||(a.startsWith("%ename ")?t.ename=a.substring(7):a.startsWith("%cname ")?t.cname=a.substring(7):a.startsWith("%prompt ")?t.cname=a.substring(8):a.startsWith("%selkey ")?t.selkey=a.substring(8):a.startsWith("%dupsel ")?t.dupsel=a.substring(8):a.startsWith("%endkey ")?t.endkey=a.substring(8):a.startsWith("%space_style ")?t.spaceStyle=a.substring(13):a.startsWith("%keep_key_case")?t.keepKeyCase=!0:a.startsWith("%symbol_kbm")?t.symbolKbm=!0:a.startsWith("%phase_auto_skip_endkey")?t.phaseAutoSkipEndKey=!0:a.startsWith("%flag_auto_select_by_phrase")?t.flagAutoSelectByPhase=!0:a.startsWith("%flag_disp_partial_match")?t.flagDispPartialMatch=!0:a.startsWith("%flag_disp_full_match")?t.flagDispFullMatch=!0:a.startsWith("%flag_vertical_selection")?t.flagVerticalSelection=!0:a.startsWith("%flag_press_full_auto_send")?t.flagPressFullAutoSend=!0:a.startsWith("%flag_unique_auto_send")?t.flagUniqueAutoSend=!0:a.startsWith("%keyname begin")?(t.keyname={},t=await r(e,t)):a.startsWith("%quick begin")?(t.unwrittenQuickList=[],t=await o(e,t)):a.startsWith("%chardef begin")&&(t.unwrittenCharDefList=[],t=await c(e,t)))),await l(e,t)}function d(e){0==e.totalPage?e.currentPage=0:e.currentPage=1,"function"==typeof e.onCurrentCandidatesChange&&e.onCurrentCandidatesChange(e.currentCandidateList),"function"==typeof e.onCandidatesChange&&e.onCandidatesChange(e.candidateList)}const u=new WeakMap;class h{constructor(){var e;this.candidateList=[],this.currentPage=0,this.maxNumOfKeys=1,(e=this).selkey="1234567890",e.spaceStyle=4,e.keepKeyCase=!1,e.symbolKbm=!1,e.phaseAutoSkipEndKey=!1,e.flagAutoSelectByPhase=!1,e.flagDispPartialMatch=!1,e.flagDispFullMatch=!1,e.flagVerticalSelection=!1,e.flagPressFullAutoSend=!1,e.flagUniqueAutoSend=!1,u.set(this,{_enable:!0,_status:0,_keys:""})}set enable(e){u.get(this)._enable=e,u.get(this)._enable||this.resetKeys()}get enable(){return u.get(this)._enable}get totalPage(){if(this.candidateList){let e=this.dupsel;return 1==this.spaceStyle&&e++,Math.ceil(this.candidateList.length/e)}return 0}get currentCandidateList(){if(this.candidateList||this.candidateList.length>0){let e=this.dupsel;return 1==this.spaceStyle&&e++,this.candidateList.slice((this.currentPage-1)*e,Math.min(this.currentPage*e,this.candidateList.length))}return this.candidateList}resetKeys(){u.get(this)._keys="",this.candidateList=[],u.get(this)._status=0,"function"==typeof this.onKeynamesChange&&this.onKeynamesChange(""),d(this)}deleteContentBackward(){if(!this.enable)return!1;if(0==u.get(this)._status){if(u.get(this)._keys.length>1){const e=u.get(this)._keys.charAt(u.get(this)._keys.length-2);return u.get(this)._keys=u.get(this)._keys.substring(0,u.get(this)._keys.length-2),this.pushKey(e),!0}return 1==u.get(this)._keys.length&&(this.resetKeys(),!0)}return 1==u.get(this)._status?(this.resetKeys(),!0):void 0}async pushKey(e){const t=this,n=function(e){u.get(t)._keys="",t.candidateList=[],u.get(t)._status=0,"function"==typeof t.onKeynamesChange&&t.onKeynamesChange(""),d(t),"function"==typeof t.onCommit&&t.onCommit(e)};if(!t.enable)return n(e),void console.log(`Commit text:${e}`);console.log(`Push key:${e}`);const a=t.db.transaction(["quick","chardef"]),s=" "==e,i="string"==typeof t.endkey&&t.endkey.indexOf(e)>-1,r="string"==typeof t.selkey&&t.selkey.indexOf(e)>-1,o="string"==typeof t.keyname[e],c=async function(e){return new Promise(function(t,n){const s=[];a.objectStore("chardef").index("keycode").openCursor(IDBKeyRange.only(e)).onsuccess=function(e){const n=e.target.result;n?(s.push(n.value.candidate),n.continue()):t(s)}})},l=u.get(t)._keys,h=t.candidateList;switch(u.get(t)._status){case 0:let g,f;if(t.candidateList=void 0,o?(u.get(t)._keys+=e,(t.flagDispFullMatch||i||2==t.spaceStyle&&u.get(t)._keys.length==t.maxNumOfKeys)&&(g=await async function(e){return new Promise(function(t,n){const s=[];a.objectStore("quick").get(e).onsuccess=function(e){if(e.target.result){const t=e.target.result.candidates;"string"==typeof t&&t.length>0&&(s=s.concat(t.split("")))}t(s)}})}(u.get(t)._keys),g.length<1&&(f=await c(u.get(t)._keys)))):s&&!f&&(f=await c(u.get(t)._keys)),g&&g.length>0?t.candidateList=g:t.candidateList=f,"function"!=typeof t.onKeynamesChange||r&&h&&0!=h.length||t.onKeynamesChange(u.get(t)._keys.split("").map(e=>t.keyname[e]).join("")),t.flagDispFullMatch&&t.candidateList&&d(t),(i||s||2==t.spaceStyle&&u.get(t)._keys.length==t.maxNumOfKeys)&&t.candidateList){if(t.candidateList.length>1)return s&&1==t.spaceStyle?void n(t.candidateList[0]):(u.get(t)._status=1,t.flagDispFullMatch||d(t),void("function"==typeof t.onEndKey&&t.onEndKey(t.currentCandidateList)));if(1==t.candidateList.length)return void n(t.candidateList[0])}if(r&&l.length>0&&h&&h.length>0){u.get(t)._keys=l,t.candidateList=h,d(t);let a=t.selkey.indexOf(e);return 1==t.spaceStyle&&a++,void(t.currentCandidateList.length>a&&n(t.currentCandidateList[a]))}if(!o)return void n(e);if(i&&1==u.get(t)._keys.length)return void n(e);break;case 1:if(r){let a=t.selkey.indexOf(e);return 1==t.spaceStyle&&a++,void(t.currentCandidateList.length>a&&n(t.currentCandidateList[a]))}return s?t.totalPage>1?void t.nextCandidateList():void n(t.currentCandidateList[0]):(n(t.currentCandidateList[0]),void t.pushKey(e))}}previousCandidateList(){return 0==this.totalPage?(this.currentPage=0,!1):(1==this.currentPage?this.currentPage=this.totalPage:this.currentPage--,"function"==typeof this.onCurrentCandidatesChange&&this.onCurrentCandidatesChange(this.currentCandidateList),!0)}nextCandidateList(){return 0==this.totalPage?(this.currentPage=0,!1):(this.currentPage==this.totalPage?this.currentPage=1:this.currentPage++,"function"==typeof this.onCurrentCandidatesChange&&this.onCurrentCandidatesChange(this.currentCandidateList),!0)}static async load(e,t){const a=t.pipeThrough(new n).pipeThrough(new s).getReader(),i=`cin_${e}`;let r=new h;return r=await l(a,r),r=await async function(e,t){let n=await new Promise((e,n)=>{let a=indexedDB.open(t);a.onsuccess=function(t){e(t.target.result)},a.onupgradeneeded=function(e){let t=e.target.result,n=t.createObjectStore("settings",{keyPath:"name"});n=t.createObjectStore("keyname",{keyPath:"key"}),n=t.createObjectStore("quick",{keyPath:"keycode"}),n=t.createObjectStore("chardef",{autoIncrement:!0}),n.createIndex("keycode","keycode",{unique:!1})},a.onerror=function(){n(`Cannot open IndexedDB for the file ${t}`)}});e.db=n,e.dbName=t,await new Promise((e,t)=>{let a=n.transaction(["settings","keyname","quick","chardef"],"readwrite");a.objectStore("settings").clear(),a.objectStore("keyname").clear(),a.objectStore("quick").clear(),a.objectStore("chardef").clear(),a.oncomplete=t=>{e()},a.onerror=e=>{t("Error when clearing old data...")}});let a=new Promise((t,a)=>{let s=n.transaction("settings","readwrite");s.objectStore("settings").add({name:"%ename",value:e.ename}),s.objectStore("settings").add({name:"%cname",value:e.cname}),s.objectStore("settings").add({name:"%prompt",value:e.prompt}),s.objectStore("settings").add({name:"%selkey",value:e.selkey}),s.objectStore("settings").add({name:"%dupsel",value:e.dupsel}),s.objectStore("settings").add({name:"%endkey",value:e.endkey}),s.objectStore("settings").add({name:"%space_style",value:e.spaceStyle}),s.objectStore("settings").add({name:"%keep_key_case",value:e.keepKeyCase}),s.objectStore("settings").add({name:"%symbol_kbm",value:e.symbolKbm}),s.objectStore("settings").add({name:"%phase_auto_skip_endkey",value:e.phaseAutoSkipEndKey}),s.objectStore("settings").add({name:"%flag_auto_select_by_phrase",value:e.flagAutoSelectByPhase}),s.objectStore("settings").add({name:"%flag_disp_partial_match",value:e.flagDispPartialMatch}),s.objectStore("settings").add({name:"%flag_disp_full_match",value:e.flagDispFullMatch}),s.objectStore("settings").add({name:"%flag_vertical_selection",value:e.flagVerticalSelection}),s.objectStore("settings").add({name:"%flag_press_full_auto_send",value:e.flagPressFullAutoSend}),s.objectStore("settings").add({name:"%flag_unique_auto_send",value:e.flagUniqueAutoSend}),s.oncomplete=e=>{t()},s.onerror=e=>{a("Cannot handle settings...")}}),s=new Promise((t,a)=>{if(e.keyname&&0!=Object.keys(e.keyname).length){let s=n.transaction("keyname","readwrite");for(let t in e.keyname)s.objectStore("keyname").add({key:t,keyname:e.keyname[t]});s.oncomplete=e=>{t()},s.onerror=e=>{a("Cannot handle keyname section...")}}else t()}),i=new Promise((t,a)=>{if(e.unwrittenQuickList&&0!=e.unwrittenQuickList.length){let s=n.transaction("quick","readwrite");for(let t of e.unwrittenQuickList)s.objectStore("quick").add(t);s.oncomplete=e=>{t()},s.onerror=e=>{a("Cannot handle quick section...")}}else t()}),r=new Promise((t,a)=>{if(e.unwrittenCharDefList&&0!=e.unwrittenCharDefList.length){let s=n.transaction("chardef","readwrite");for(let t of e.unwrittenCharDefList)s.objectStore("chardef").add(t);s.oncomplete=e=>{t()},s.onerror=e=>{a("Cannot handle chardef section...")}}else t()});return await Promise.all([a,s,i,r]),delete e.unwrittenQuickList,delete e.unwrittenCharDefList,e}(r,i),r}}document.getElementById("btn_load").addEventListener("change",e=>{if(e.target.files.length>0){e.target.disabled=!0;const t=e.target.files[0];document.getElementById("lbl_btn_load").textContent="上傳中…";const n=t.stream();h.load(t.name,n).then(e=>{document.getElementById("lbl_btn_load").textContent="完成",e.onKeynamesChange=function(e){document.getElementById("lbl_composing_text").textContent=e},e.onCurrentCandidatesChange=function(t){let n,a="";for(let s in t)n=s,1==e.spaceStyle&&n--,a+=`<span style="display:inline-block; width:1em; text-align:right;">${n<0?" ":e.selkey.charAt(n)}</span><span>${t[s]}</span>`;document.getElementById("lbl_candidate").innerHTML=a},e.onCommit=function(e){const t=document.getElementById("ta_cinotepad"),n=t.selectionStart+e.length,a=t.value.substring(0,t.selectionStart),s=t.value.substring(t.selectionEnd);t.value=a+e+s,t.setSelectionRange(n,n)},document.getElementById("lbl_im_name").textContent=e.cname+" ",document.getElementById("ta_cinotepad").onbeforeinput=function(t){"insertText"==t.inputType?(e.pushKey(t.data),t.preventDefault()):"deleteContentBackward"==t.inputType&&e.deleteContentBackward()&&t.preventDefault()},document.getElementById("ta_cinotepad").onkeydown=function(t){"Escape"==t.key?(e.resetKeys(),t.preventDefault()):"PageUp"==t.key?e.previousCandidateList()&&t.preventDefault():"PageDown"==t.key&&e.nextCandidateList()&&t.preventDefault()},e.enable=document.getElementById("checkbox_enable").checked,document.getElementById("checkbox_enable").onchange=function(t){e.enable=t.target.checked}}).catch(t=>{e.target.disabled=!1,Promise.reject(t)})}})})();