(()=>{"use strict";const e={start(){this.decoder=new TextDecoder(this.encoding,this.options)},transform(e,t){t.enqueue(this.decoder.decode(e,{stream:!0}))}},t=new WeakMap;class n extends TransformStream{constructor(n="utf-8",{...a}={}){let i={...e,encoding:n,options:a};super(i),t.set(this,i)}get encoding(){return t.get(this).decoder.encoding}get fatal(){return t.get(this).decoder.fatal}get ignoreBOM(){return t.get(this).decoder.ignoreBOM}}const a={transform(e,t){let n,a=0;for(;;){if(n=e.indexOf("\n",a),!(n>-1)){let n=e.substring(a);n=n.replaceAll("\r",""),0==n.length?this._remainChunk&&(n=this._remainChunk+n,t.enqueue(n),this._remainChunk=void 0):(this._remainChunk||(this._remainChunk=""),this._remainChunk+=n);break}{let i=e.substring(a,n);i=i.replaceAll("\r",""),this._remainChunk&&(i=this._remainChunk+i,this._remainChunk=void 0),t.enqueue(i),a=n+1}}},flush(e){this._remainChunk&&(e.enqueue(this._remainChunk),this._remainChunk=void 0)}};class i extends TransformStream{constructor({...e}={}){super({...a,options:e})}}document.getElementById("btn_load").addEventListener("change",e=>{if(e.target.files.length>0){e.target.disabled=!0;const t=e.target.files[0];document.getElementById("lbl_btn_load").textContent="上傳中…";const a=t.stream();(async function(e,t){let a={},s=t.pipeThrough(new n).pipeThrough(new i).getReader(),r=function(e){let t,n,a;return t=e.indexOf(" "),n=e.indexOf("\t"),a=-1==n||t>-1&&t<n?t:n,a},o=async function(e,t){let{done:n,value:a}=await e.read();if(n)return t;if(a.length>0){if(a.startsWith("%keyname end"))return t;if(a.startsWith(" # ")&&a.length>3)t.keyname["#"]=a.substring(3);else{let e=r(a);e>0&&e<a.length-1&&(t.keyname[a.substring(0,e)]=a.substring(e+1).trim())}}return await o(e,t)},l=async function(e,t){let{done:n,value:a}=await e.read();if(n)return t;{let n,i;if(a.length>0){if(a.startsWith("%quick end"))return t;if(a.startsWith(" # ")&&a.length>3)n="#",i=a.substring(3).trim(),t.unwrittenQuickList.push({keycode:n,candidates:i});else{let e=r(a);e>0&&e<a.length-1&&(n=a.substring(0,e),i=a.substring(e+1).trim(),t.unwrittenQuickList.push({keycode:n,candidates:i}),t.maxNumOfKeys=Math.max(t.maxNumOfKeys,n.length))}}return await l(e,t)}},c=async function(e,t){let{done:n,value:a}=await e.read();if(n)return t;{let n,i;if(a.length>0){if(a.startsWith("%chardef end"))return t;if(a.startsWith(" # ")&&a.length>3)n="#",i=a.substring(3).trim(),t.unwrittenCharDefList.push({keycode:n,candidate:i});else{let e=r(a);e>0&&e<a.length-1&&(n=a.substring(0,e),i=a.substring(e+1).trim(),t.unwrittenCharDefList.push({keycode:n,candidate:i}),t.maxNumOfKeys=Math.max(t.maxNumOfKeys,n.length))}}return await c(e,t)}},d=async function(e,t){let{done:n,value:a}=await e.read();if(n){if(t.dupsel||(t.dupsel=t.selkey.length),!t.keepKeyCase){const e=t.keyname;t.keyname={};for(let n in e)t.keyname[n.toLowerCase()]=e[n];for(let e in t.unwrittenQuickList)t.unwrittenQuickList[e].keycode=t.unwrittenQuickList[e].keycode.toLowerCase();for(let e in t.unwrittenCharDefList)t.unwrittenCharDefList[e].keycode=t.unwrittenCharDefList[e].keycode.toLowerCase()}return t}return a=function(e){let t=e.indexOf("#");return t>-1&&(e=e.substring(0,t).trim()),e}(a),a.length>0&&(a.startsWith("%gen_inp")||(a.startsWith("%ename ")?t.ename=a.substring(7):a.startsWith("%cname ")?t.cname=a.substring(7):a.startsWith("%prompt ")?t.cname=a.substring(8):a.startsWith("%selkey ")?t.selkey=a.substring(8):a.startsWith("%dupsel ")?t.dupsel=a.substring(8):a.startsWith("%endkey ")?t.endkey=a.substring(8):a.startsWith("%space_style ")?t.spaceStyle=a.substring(13):a.startsWith("%keep_key_case")?t.keepKeyCase=!0:a.startsWith("%symbol_kbm")?t.symbolKbm=!0:a.startsWith("%phase_auto_skip_endkey")?t.phaseAutoSkipEndKey=!0:a.startsWith("%flag_auto_select_by_phrase")?t.flagAutoSelectByPhase=!0:a.startsWith("%flag_disp_partial_match")?t.flagDispPartialMatch=!0:a.startsWith("%flag_disp_full_match")?t.flagDispFullMatch=!0:a.startsWith("%flag_vertical_selection")?t.flagVerticalSelection=!0:a.startsWith("%flag_press_full_auto_send")?t.flagPressFullAutoSend=!0:a.startsWith("%flag_unique_auto_send")?t.flagUniqueAutoSend=!0:a.startsWith("%keyname begin")?(t.keyname={},t=await o(e,t)):a.startsWith("%quick begin")?(t.unwrittenQuickList=[],t=await l(e,t)):a.startsWith("%chardef begin")&&(t.unwrittenCharDefList=[],t=await c(e,t)))),await d(e,t)};a._enable=!0,a.candidateList=[],a.maxNumOfKeys=1,a=function(e){return e.selkey="1234567890",e.spaceStyle=4,e.keepKeyCase=!1,e.symbolKbm=!1,e.phaseAutoSkipEndKey=!1,e.flagAutoSelectByPhase=!1,e.flagDispPartialMatch=!1,e.flagDispFullMatch=!1,e.flagVerticalSelection=!1,e.flagPressFullAutoSend=!1,e.flagUniqueAutoSend=!1,e}(a);const u=`cin_${e}`;return Promise.resolve(a).then(e=>d(s,e)).then(e=>async function(e,t){let n=await new Promise((e,n)=>{let a=indexedDB.open(t);a.onsuccess=function(t){e(t.target.result)},a.onupgradeneeded=function(e){let t=e.target.result,n=t.createObjectStore("settings",{keyPath:"name"});n=t.createObjectStore("keyname",{keyPath:"key"}),n=t.createObjectStore("quick",{keyPath:"keycode"}),n=t.createObjectStore("chardef",{autoIncrement:!0}),n.createIndex("keycode","keycode",{unique:!1})},a.onerror=function(){n(`Cannot open IndexedDB for the file ${t}`)}});e.db=n,e.dbName=t,await new Promise((e,t)=>{let a=n.transaction(["settings","keyname","quick","chardef"],"readwrite");a.objectStore("settings").clear(),a.objectStore("keyname").clear(),a.objectStore("quick").clear(),a.objectStore("chardef").clear(),a.oncomplete=t=>{e()},a.onerror=e=>{t("Error when clearing old data...")}});let a=new Promise((t,a)=>{let i=n.transaction("settings","readwrite");i.objectStore("settings").add({name:"%ename",value:e.ename}),i.objectStore("settings").add({name:"%cname",value:e.cname}),i.objectStore("settings").add({name:"%prompt",value:e.prompt}),i.objectStore("settings").add({name:"%selkey",value:e.selkey}),i.objectStore("settings").add({name:"%dupsel",value:e.dupsel}),i.objectStore("settings").add({name:"%endkey",value:e.endkey}),i.objectStore("settings").add({name:"%space_style",value:e.spaceStyle}),i.objectStore("settings").add({name:"%keep_key_case",value:e.keepKeyCase}),i.objectStore("settings").add({name:"%symbol_kbm",value:e.symbolKbm}),i.objectStore("settings").add({name:"%phase_auto_skip_endkey",value:e.phaseAutoSkipEndKey}),i.objectStore("settings").add({name:"%flag_auto_select_by_phrase",value:e.flagAutoSelectByPhase}),i.objectStore("settings").add({name:"%flag_disp_partial_match",value:e.flagDispPartialMatch}),i.objectStore("settings").add({name:"%flag_disp_full_match",value:e.flagDispFullMatch}),i.objectStore("settings").add({name:"%flag_vertical_selection",value:e.flagVerticalSelection}),i.objectStore("settings").add({name:"%flag_press_full_auto_send",value:e.flagPressFullAutoSend}),i.objectStore("settings").add({name:"%flag_unique_auto_send",value:e.flagUniqueAutoSend}),i.oncomplete=e=>{t()},i.onerror=e=>{a("Cannot handle settings...")}}),i=new Promise((t,a)=>{if(e.keyname&&0!=Object.keys(e.keyname).length){let i=n.transaction("keyname","readwrite");for(let t in e.keyname)i.objectStore("keyname").add({key:t,keyname:e.keyname[t]});i.oncomplete=e=>{t()},i.onerror=e=>{a("Cannot handle keyname section...")}}else t()}),s=new Promise((t,a)=>{if(e.unwrittenQuickList&&0!=e.unwrittenQuickList.length){let i=n.transaction("quick","readwrite");for(let t of e.unwrittenQuickList)i.objectStore("quick").add(t);i.oncomplete=e=>{t()},i.onerror=e=>{a("Cannot handle quick section...")}}else t()}),r=new Promise((t,a)=>{if(e.unwrittenCharDefList&&0!=e.unwrittenCharDefList.length){let i=n.transaction("chardef","readwrite");for(let t of e.unwrittenCharDefList)i.objectStore("chardef").add(t);i.oncomplete=e=>{t()},i.onerror=e=>{a("Cannot handle chardef section...")}}else t()});return await Promise.all([a,i,s,r]),delete e.unwrittenQuickList,delete e.unwrittenCharDefList,e}(e,u)).then(e=>{let t=0,n="";e.currentPage=0,Object.defineProperty(e,"enable",{set(t){e._enable=t,e._enable||e.resetKeys()},get:()=>e._enable}),Object.defineProperty(e,"totalPage",{get(){if(e.candidateList){let t=e.dupsel;return 1==e.spaceStyle&&t++,Math.ceil(e.candidateList.length/t)}return 0}}),Object.defineProperty(e,"currentCandidateList",{get(){if(e.candidateList||e.candidateList.length>0){let t=e.dupsel;return 1==e.spaceStyle&&t++,e.candidateList.slice((e.currentPage-1)*t,Math.min(e.currentPage*t,e.candidateList.length))}return e.candidateList}});let a=function(){0==e.totalPage?e.currentPage=0:e.currentPage=1,"function"==typeof e.onCurrentCandidatesChange&&e.onCurrentCandidatesChange(e.currentCandidateList),"function"==typeof e.onCandidatesChange&&e.onCandidatesChange(e.candidateList)};return e.resetKeys=function(){n="",e.candidateList=[],t=0,"function"==typeof e.onKeynamesChange&&e.onKeynamesChange(""),a()},e.deleteContentBackward=function(){if(!e.enable)return!1;if(0==t){if(n.length>1){let t=n.charAt(n.length-2);return n=n.substring(0,n.length-2),e.pushKey(t),!0}return 1==n.length&&(e.resetKeys(),!0)}return 1==t?(e.resetKeys(),!0):void 0},e.pushKey=async function(i){let s=function(i){n="",e.candidateList=[],t=0,"function"==typeof e.onKeynamesChange&&e.onKeynamesChange(""),a(),"function"==typeof e.onCommit&&e.onCommit(i)};if(!e.enable)return s(i),void console.log(`Commit text:${i}`);console.log(`Push key:${i}`);let r=e.db.transaction(["quick","chardef"]),o=" "==i,l="string"==typeof e.endkey&&e.endkey.indexOf(i)>-1,c="string"==typeof e.selkey&&e.selkey.indexOf(i)>-1,d="string"==typeof e.keyname[i],u=async function(e){return new Promise(function(t,n){let a=[];r.objectStore("chardef").index("keycode").openCursor(IDBKeyRange.only(e)).onsuccess=function(e){const n=e.target.result;n?(a.push(n.value.candidate),n.continue()):t(a)}})},g=n,h=e.candidateList;switch(t){case 0:let f,m;if(e.candidateList=void 0,d?(n+=i,(e.flagDispFullMatch||l||2==e.spaceStyle&&n.length==e.maxNumOfKeys)&&(f=await async function(e){return new Promise(function(t,n){let a=[];r.objectStore("quick").get(e).onsuccess=function(e){if(e.target.result){const t=e.target.result.candidates;"string"==typeof t&&t.length>0&&(a=a.concat(t.split("")))}t(a)}})}(n),f.length<1&&(m=await u(n)))):o&&!m&&(m=await u(n)),f&&f.length>0?e.candidateList=f:e.candidateList=m,"function"!=typeof e.onKeynamesChange||c&&h&&0!=h.length||e.onKeynamesChange(function(t){return t.split("").map(t=>e.keyname[t]).join("")}(n)),e.flagDispFullMatch&&e.candidateList&&a(),(l||o||2==e.spaceStyle&&n.length==e.maxNumOfKeys)&&e.candidateList){if(e.candidateList.length>1)return o&&1==e.spaceStyle?void s(e.candidateList[0]):(t=1,e.flagDispFullMatch||a(),void("function"==typeof e.onEndKey&&e.onEndKey(e.currentCandidateList)));if(1==e.candidateList.length)return void s(e.candidateList[0])}if(c&&g.length>0&&h&&h.length>0){n=g,e.candidateList=h,a();let t=e.selkey.indexOf(i);return 1==e.spaceStyle&&t++,void(e.currentCandidateList.length>t&&s(e.currentCandidateList[t]))}if(!d)return void s(i);if(l&&1==n.length)return void s(i);break;case 1:if(c){let t=e.selkey.indexOf(i);return 1==e.spaceStyle&&t++,void(e.currentCandidateList.length>t&&s(e.currentCandidateList[t]))}return o?e.totalPage>1?void e.nextCandidateList():void s(e.currentCandidateList[0]):(s(e.currentCandidateList[0]),void e.pushKey(i))}},e.previousCandidateList=function(){return 0==e.totalPage?(e.currentPage=0,!1):(1==e.currentPage?e.currentPage=e.totalPage:e.currentPage--,"function"==typeof e.onCurrentCandidatesChange&&e.onCurrentCandidatesChange(e.currentCandidateList),!0)},e.nextCandidateList=function(){return 0==e.totalPage?(e.currentPage=0,!1):(e.currentPage==e.totalPage?e.currentPage=1:e.currentPage++,"function"==typeof e.onCurrentCandidatesChange&&e.onCurrentCandidatesChange(e.currentCandidateList),!0)},e})})(t.name,a).then(e=>{document.getElementById("lbl_btn_load").textContent="完成",e.onKeynamesChange=function(e){document.getElementById("lbl_composing_text").textContent=e},e.onCurrentCandidatesChange=function(t){let n,a="";for(let i in t)n=i,1==e.spaceStyle&&n--,a+=`<span style="display:inline-block; width:1em; text-align:right;">${n<0?" ":e.selkey.charAt(n)}</span><span>${t[i]}</span>`;document.getElementById("lbl_candidate").innerHTML=a},e.onCommit=function(e){const t=document.getElementById("ta_cinotepad"),n=t.selectionStart+e.length,a=t.value.substring(0,t.selectionStart),i=t.value.substring(t.selectionEnd);t.value=a+e+i,t.setSelectionRange(n,n)},document.getElementById("lbl_im_name").textContent=e.cname+" ",document.getElementById("ta_cinotepad").onbeforeinput=function(t){"insertText"==t.inputType?(e.pushKey(t.data),t.preventDefault()):"deleteContentBackward"==t.inputType&&e.deleteContentBackward()&&t.preventDefault()},document.getElementById("ta_cinotepad").onkeydown=function(t){"Escape"==t.key?(e.resetKeys(),t.preventDefault()):"PageUp"==t.key?e.previousCandidateList()&&t.preventDefault():"PageDown"==t.key&&e.nextCandidateList()&&t.preventDefault()},e.enable=document.getElementById("checkbox_enable").checked,document.getElementById("checkbox_enable").onchange=function(t){e.enable=t.target.checked}}).catch(t=>{e.target.disabled=!1,Promise.reject(t)})}})})();